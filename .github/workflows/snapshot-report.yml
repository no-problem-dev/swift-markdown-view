name: Snapshot Report

on:
  # 手動実行用
  workflow_dispatch:

  # releaseブランチからmainへのマージ時に実行
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: "pages-snapshots"
  cancel-in-progress: true

jobs:
  snapshot-test:
    name: Run Snapshot Tests
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'

      - name: List available schemes
        run: |
          xcodebuild -list 2>&1 | head -30

      - name: Run Snapshot Tests + Gallery Generation on iOS Simulator
        id: snapshot-test
        continue-on-error: true
        env:
          SNAPSHOT_RECORD: "1"
        run: |
          # Run snapshot tests on iOS Simulator in recording mode
          # Then run gallery generation to produce HTML
          # WebView tests (Mermaid) are excluded on CI
          xcodebuild test \
            -scheme SwiftMarkdownView \
            -destination 'platform=iOS Simulator,name=iPhone 16e' \
            -skipMacroValidation \
            -only-testing SwiftMarkdownViewTests/BlockElementSnapshotTests \
            -only-testing SwiftMarkdownViewTests/CodeBlockSnapshotTests \
            -only-testing SwiftMarkdownViewTests/InlineElementSnapshotTests \
            -only-testing SwiftMarkdownViewTests/MediaSnapshotTests \
            -only-testing SwiftMarkdownViewTests/ComplexDocumentSnapshotTests \
            -only-testing SwiftMarkdownViewTests/AsideSnapshotTests \
            -only-testing SwiftMarkdownViewTests/GalleryGeneratorTests \
            2>&1 | tail -80

      - name: Collect gallery and snapshot images
        if: always()
        run: |
          mkdir -p snapshot-report

          SNAPSHOTS_DIR="Tests/SwiftMarkdownViewTests/Snapshots"

          # Copy the VisualTesting-generated gallery HTML
          if [ -f "$SNAPSHOTS_DIR/gallery.html" ]; then
            cp "$SNAPSHOTS_DIR/gallery.html" snapshot-report/index.html
            echo "Gallery HTML copied successfully"
          else
            echo "WARNING: gallery.html not found at $SNAPSHOTS_DIR/gallery.html"
            echo "Searching for gallery.html..."
            find . -name "gallery.html" -not -path "./.build/*" 2>/dev/null
          fi

          # Copy snapshot images (needed for the gallery to reference)
          if [ -d "$SNAPSHOTS_DIR/__Snapshots__" ]; then
            cp -r "$SNAPSHOTS_DIR/__Snapshots__" snapshot-report/__Snapshots__
            echo "Snapshot images copied"
          else
            echo "WARNING: __Snapshots__ directory not found"
            find Tests -name "__Snapshots__" -type d 2>/dev/null
          fi

          # Copy catalog JSON if present
          if [ -f "$SNAPSHOTS_DIR/snapshot-catalog.json" ]; then
            cp "$SNAPSHOTS_DIR/snapshot-catalog.json" snapshot-report/
          fi

          # List collected files
          echo "---"
          echo "Report contents:"
          find snapshot-report -type f | sort
          echo "---"
          TOTAL=$(find snapshot-report -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "Total snapshot images: $TOTAL"

      - name: Upload Snapshot Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-report
          path: snapshot-report/
          retention-days: 30

      - name: Set test result summary
        if: always()
        id: summary
        run: |
          TOTAL=$(find snapshot-report -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./snapshot-report
          destination_dir: snapshots
          keep_files: false

    outputs:
      total-snapshots: ${{ steps.summary.outputs.total }}

  notify-slack:
    name: Notify Slack
    needs: [snapshot-test]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":white_check_mark: SwiftMarkdownView Snapshot Report",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nGenerated"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Snapshots:*\n${{ needs.snapshot-test.outputs.total-snapshots }} images"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.ref == 'refs/heads/main' && 'https://no-problem-dev.github.io/swift-markdown-view/snapshots/' || format('{0}/{1}/actions/runs/{2}#artifacts', github.server_url, github.repository, github.run_id) }}|:bar_chart: View Snapshot Report> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|:gear: View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
